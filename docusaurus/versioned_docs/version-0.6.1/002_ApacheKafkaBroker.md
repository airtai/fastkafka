
<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

``` python
import shlex
from tempfile import TemporaryDirectory

import pytest
from aiokafka import AIOKafkaConsumer, AIOKafkaProducer

from fastkafka._components.helpers import change_dir
from fastkafka._components.logger import supress_timestamps
```

``` python
supress_timestamps()
logger = get_logger(__name__, level=20)
logger.info("ok")
```

    [INFO] __main__: ok

### Local Kafka

#### Kafka and zookeeper config helpers

------------------------------------------------------------------------

<a
href="https://github.com/airtai/fastkafka/blob/main/fastkafka/_testing/apache_kafka_broker.py#L35"
target="_blank" style={{float: 'right', fontSize: 'smaller'}}>source</a>

### get_zookeeper_config_string

>      get_zookeeper_config_string (data_dir:Union[str,pathlib.Path],
>                                   zookeeper_port:int=2181)

Generates a zookeeeper configuration string that can be exported to file
and used to start a zookeeper instance.

Args: data_dir: Path to the directory where the zookeepeer instance will
save data zookeeper_port: Port for clients (Kafka brokes) to connect
Returns: Zookeeper configuration string.

|                | **Type** | **Default** | **Details**                                 |
|----------------|----------|-------------|---------------------------------------------|
| data_dir       | Union    |             | the directory where the snapshot is stored. |
| zookeeper_port | int      | 2181        | the port at which the clients will connect  |
| **Returns**    | **str**  |             |                                             |

``` python
assert (
    get_zookeeper_config_string(data_dir="..")
    == """dataDir=../zookeeper
clientPort=2181
maxClientCnxns=0
admin.enableServer=false
"""
)

assert (
    get_zookeeper_config_string(data_dir="..", zookeeper_port=100)
    == """dataDir=../zookeeper
clientPort=100
maxClientCnxns=0
admin.enableServer=false
"""
)
```

------------------------------------------------------------------------

<a
href="https://github.com/airtai/fastkafka/blob/main/fastkafka/_testing/apache_kafka_broker.py#L59"
target="_blank" style={{float: 'right', fontSize: 'smaller'}}>source</a>

### get_kafka_config_string

>      get_kafka_config_string (data_dir:Union[str,pathlib.Path],
>                               zookeeper_port:int=2181, listener_port:int=9092)

Generates a kafka broker configuration string that can be exported to
file and used to start a kafka broker instance.

Args: data_dir: Path to the directory where the kafka broker instance
will save data zookeeper_port: Port on which the zookeeper instance is
running listener_port: Port on which the clients (producers and
consumers) can connect Returns: Kafka broker configuration string.

``` python
actual = get_kafka_config_string(data_dir="..", listener_port=9999)
assert "log.dirs=../kafka_logs" in actual
assert "listeners=PLAINTEXT://:9999" in actual
```

------------------------------------------------------------------------

### ApacheKafkaBroker

>      ApacheKafkaBroker (topics:Iterable[str]=[], retries:int=3,
>                         apply_nest_asyncio:bool=False,
>                         zookeeper_port:int=2181, listener_port:int=9092)

ApacheKafkaBroker class, used for running unique kafka brokers in tests
to prevent topic clashing.

``` python
# print(combine_params(combine_params(ApacheKafkaBroker, get_kafka_config_string), get_zookeeper_config_string).__doc__)
```

``` python
# TODO: test

broker = ApacheKafkaBroker()
broker._check_deps()
```

    [INFO] __main__: Java is already installed.
    [INFO] __main__: Kafka is already installed.

------------------------------------------------------------------------

<a
href="https://github.com/airtai/fastkafka/blob/main/fastkafka/_testing/apache_kafka_broker.py#L308"
target="_blank" style={{float: 'right', fontSize: 'smaller'}}>source</a>

### run_and_match

>      run_and_match (*args:str, capture:str='stdout', timeout:int=5,
>                     pattern:str, num_to_match:int=1)

``` python
cmd = "import datetime; from time import sleep; sleep(3); print('time is:' + str(datetime.datetime.now()))"
# print('"' + cmd + '"')

with pytest.raises(TimeoutError):
    proc = await run_and_match("python3", "-c", cmd, pattern="time is", timeout=1)

with pytest.raises(RuntimeError):
    proc = await run_and_match(
        "python3", "-c", "should break on this", pattern="time is", timeout=5
    )

proc = await run_and_match("python3", "-c", cmd, pattern="time is", timeout=5)
```

    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 70268...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 70268 terminated.

``` python
cmd = "import datetime; from time import sleep; sleep(3); print('time is:' + str(datetime.datetime.now())); print('time is:' + str(datetime.datetime.now()))"

with pytest.raises(TimeoutError):
    proc = await run_and_match("python3", "-c", cmd, pattern="time is", timeout=5, num_to_match=3)


proc = await run_and_match("python3", "-c", cmd, pattern="time is", timeout=5, num_to_match=2)
```

------------------------------------------------------------------------

<a
href="https://github.com/airtai/fastkafka/blob/main/fastkafka/_testing/apache_kafka_broker.py#L385"
target="_blank" style={{float: 'right', fontSize: 'smaller'}}>source</a>

### ApacheKafkaBroker.get_service_config_string

>      ApacheKafkaBroker.get_service_config_string (service:str,
>                                                   data_dir:pathlib.Path)

------------------------------------------------------------------------

<a
href="https://github.com/airtai/fastkafka/blob/main/fastkafka/_testing/apache_kafka_broker.py#L370"
target="_blank" style={{float: 'right', fontSize: 'smaller'}}>source</a>

### write_config_and_run

>      write_config_and_run (config:str, config_path:Union[str,pathlib.Path],
>                            run_cmd:str)

------------------------------------------------------------------------

<a
href="https://github.com/airtai/fastkafka/blob/main/fastkafka/_testing/apache_kafka_broker.py#L362"
target="_blank" style={{float: 'right', fontSize: 'smaller'}}>source</a>

### get_free_port

>      get_free_port ()

``` python
broker = ApacheKafkaBroker()
async with broker:
    pass

print("*" * 50 + "ZOOKEEPER LOGS" + "+" * 50)
zookeeper_output, _ = await broker.zookeeper_task.communicate()
print(zookeeper_output.decode("UTF-8"))

print("*" * 50 + "KAFKA LOGS" + "+" * 50)
kafka_output, _ = await broker.kafka_task.communicate()
print(kafka_output.decode("UTF-8"))
```

    [INFO] __main__: Java is already installed.
    [INFO] __main__: Kafka is already installed.
    [INFO] __main__: Starting zookeeper...
    stdout=b'', stderr=b'', returncode=1
    [INFO] __main__: zookeeper startup falied, generating a new port and retrying...
    [INFO] __main__: port=34263
    [INFO] __main__: Starting kafka...
    [INFO] __main__: Local Kafka broker up and running on 127.0.0.1:9092
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 719446...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 719446 terminated.
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 719086...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 719086 terminated.
    **************************************************ZOOKEEPER LOGS++++++++++++++++++++++++++++++++++++++++++++++++++
    [2023-03-08 13:34:48,027] INFO zookeeper.request_throttler.shutdownTimeout = 10000 (org.apache.zookeeper.server.RequestThrottler)
    [2023-03-08 13:34:48,036] INFO PrepRequestProcessor (sid:0) started, reconfigEnabled=false (org.apache.zookeeper.server.PrepRequestProcessor)
    [2023-03-08 13:34:48,048] INFO Using checkIntervalMs=60000 maxPerMinute=10000 maxNeverUsedIntervalMs=0 (org.apache.zookeeper.server.ContainerManager)
    [2023-03-08 13:34:48,049] INFO ZooKeeper audit is disabled. (org.apache.zookeeper.audit.ZKAuditProvider)
    [2023-03-08 13:34:49,241] INFO Creating new log file: log.1 (org.apache.zookeeper.server.persistence.FileTxnLog)

    **************************************************KAFKA LOGS++++++++++++++++++++++++++++++++++++++++++++++++++
    [2023-03-08 13:34:50,640] INFO [BrokerToControllerChannelManager broker=0 name=alterPartition]: Recorded new controller, from now on will use node tvrtko-fastkafka-devel:9092 (id: 0 rack: null) (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:34:50,682] INFO [BrokerToControllerChannelManager broker=0 name=forwarding]: Recorded new controller, from now on will use node tvrtko-fastkafka-devel:9092 (id: 0 rack: null) (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:34:51,493] INFO Terminating process due to signal SIGTERM (org.apache.kafka.common.utils.LoggingSignalHandler)
    [2023-03-08 13:34:51,495] INFO [KafkaServer id=0] shutting down (kafka.server.KafkaServer)
    [2023-03-08 13:34:51,496] INFO [KafkaServer id=0] Starting controlled shutdown (kafka.server.KafkaServer)
    [2023-03-08 13:34:51,517] INFO [KafkaServer id=0] Controlled shutdown request returned successfully after 16ms (kafka.server.KafkaServer)
    [2023-03-08 13:34:51,520] INFO [/config/changes-event-process-thread]: Shutting down (kafka.common.ZkNodeChangeNotificationListener$ChangeEventProcessThread)
    [2023-03-08 13:34:51,526] INFO [/config/changes-event-process-thread]: Stopped (kafka.common.ZkNodeChangeNotificationListener$ChangeEventProcessThread)
    [2023-03-08 13:34:51,527] INFO [/config/changes-event-process-thread]: Shutdown completed (kafka.common.ZkNodeChangeNotificationListener$ChangeEventProcessThread)
    [2023-03-08 13:34:51,528] INFO [SocketServer listenerType=ZK_BROKER, nodeId=0] Stopping socket server request processors (kafka.network.SocketServer)
    [2023-03-08 13:34:51,534] INFO [SocketServer listenerType=ZK_BROKER, nodeId=0] Stopped socket server request processors (kafka.network.SocketServer)
    [2023-03-08 13:34:51,535] INFO [data-plane Kafka Request Handler on Broker 0], shutting down (kafka.server.KafkaRequestHandlerPool)
    [2023-03-08 13:34:51,537] INFO [data-plane Kafka Request Handler on Broker 0], shut down completely (kafka.server.KafkaRequestHandlerPool)
    [2023-03-08 13:34:51,547] INFO [ExpirationReaper-0-AlterAcls]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,549] INFO [ExpirationReaper-0-AlterAcls]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,549] INFO [ExpirationReaper-0-AlterAcls]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,549] INFO [KafkaApi-0] Shutdown complete. (kafka.server.KafkaApis)
    [2023-03-08 13:34:51,550] INFO [ExpirationReaper-0-topic]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,551] INFO [ExpirationReaper-0-topic]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,551] INFO [ExpirationReaper-0-topic]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,552] INFO [TransactionCoordinator id=0] Shutting down. (kafka.coordinator.transaction.TransactionCoordinator)
    [2023-03-08 13:34:51,553] INFO [Transaction State Manager 0]: Shutdown complete (kafka.coordinator.transaction.TransactionStateManager)
    [2023-03-08 13:34:51,553] INFO [Transaction Marker Channel Manager 0]: Shutting down (kafka.coordinator.transaction.TransactionMarkerChannelManager)
    [2023-03-08 13:34:51,559] INFO [Transaction Marker Channel Manager 0]: Stopped (kafka.coordinator.transaction.TransactionMarkerChannelManager)
    [2023-03-08 13:34:51,559] INFO [Transaction Marker Channel Manager 0]: Shutdown completed (kafka.coordinator.transaction.TransactionMarkerChannelManager)
    [2023-03-08 13:34:51,560] INFO [TransactionCoordinator id=0] Shutdown complete. (kafka.coordinator.transaction.TransactionCoordinator)
    [2023-03-08 13:34:51,561] INFO [GroupCoordinator 0]: Shutting down. (kafka.coordinator.group.GroupCoordinator)
    [2023-03-08 13:34:51,561] INFO [ExpirationReaper-0-Heartbeat]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,562] INFO [ExpirationReaper-0-Heartbeat]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,562] INFO [ExpirationReaper-0-Heartbeat]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,563] INFO [ExpirationReaper-0-Rebalance]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,564] INFO [ExpirationReaper-0-Rebalance]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,564] INFO [ExpirationReaper-0-Rebalance]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,565] INFO [GroupCoordinator 0]: Shutdown complete. (kafka.coordinator.group.GroupCoordinator)
    [2023-03-08 13:34:51,566] INFO [ReplicaManager broker=0] Shutting down (kafka.server.ReplicaManager)
    [2023-03-08 13:34:51,566] INFO [LogDirFailureHandler]: Shutting down (kafka.server.ReplicaManager$LogDirFailureHandler)
    [2023-03-08 13:34:51,566] INFO [LogDirFailureHandler]: Shutdown completed (kafka.server.ReplicaManager$LogDirFailureHandler)
    [2023-03-08 13:34:51,566] INFO [LogDirFailureHandler]: Stopped (kafka.server.ReplicaManager$LogDirFailureHandler)
    [2023-03-08 13:34:51,567] INFO [ReplicaFetcherManager on broker 0] shutting down (kafka.server.ReplicaFetcherManager)
    [2023-03-08 13:34:51,567] INFO [ReplicaFetcherManager on broker 0] shutdown completed (kafka.server.ReplicaFetcherManager)
    [2023-03-08 13:34:51,568] INFO [ReplicaAlterLogDirsManager on broker 0] shutting down (kafka.server.ReplicaAlterLogDirsManager)
    [2023-03-08 13:34:51,568] INFO [ReplicaAlterLogDirsManager on broker 0] shutdown completed (kafka.server.ReplicaAlterLogDirsManager)
    [2023-03-08 13:34:51,568] INFO [ExpirationReaper-0-Fetch]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,569] INFO [ExpirationReaper-0-Fetch]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,569] INFO [ExpirationReaper-0-Fetch]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,569] INFO [ExpirationReaper-0-Produce]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,577] INFO [ExpirationReaper-0-Produce]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,577] INFO [ExpirationReaper-0-Produce]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,577] INFO [ExpirationReaper-0-DeleteRecords]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,578] INFO [ExpirationReaper-0-DeleteRecords]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,578] INFO [ExpirationReaper-0-DeleteRecords]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,578] INFO [ExpirationReaper-0-ElectLeader]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,578] INFO [ExpirationReaper-0-ElectLeader]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,578] INFO [ExpirationReaper-0-ElectLeader]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:34:51,583] INFO [ReplicaManager broker=0] Shut down completely (kafka.server.ReplicaManager)
    [2023-03-08 13:34:51,584] INFO [BrokerToControllerChannelManager broker=0 name=alterPartition]: Shutting down (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:34:51,584] INFO [BrokerToControllerChannelManager broker=0 name=alterPartition]: Stopped (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:34:51,584] INFO [BrokerToControllerChannelManager broker=0 name=alterPartition]: Shutdown completed (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:34:51,586] INFO Broker to controller channel manager for alterPartition shutdown (kafka.server.BrokerToControllerChannelManagerImpl)
    [2023-03-08 13:34:51,586] INFO [BrokerToControllerChannelManager broker=0 name=forwarding]: Shutting down (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:34:51,586] INFO [BrokerToControllerChannelManager broker=0 name=forwarding]: Stopped (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:34:51,586] INFO [BrokerToControllerChannelManager broker=0 name=forwarding]: Shutdown completed (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:34:51,587] INFO Broker to controller channel manager for forwarding shutdown (kafka.server.BrokerToControllerChannelManagerImpl)
    [2023-03-08 13:34:51,587] INFO Shutting down. (kafka.log.LogManager)
    [2023-03-08 13:34:51,617] INFO Shutdown complete. (kafka.log.LogManager)
    [2023-03-08 13:34:51,622] INFO [feature-zk-node-event-process-thread]: Shutting down (kafka.server.FinalizedFeatureChangeListener$ChangeNotificationProcessorThread)
    [2023-03-08 13:34:51,622] INFO [feature-zk-node-event-process-thread]: Shutdown completed (kafka.server.FinalizedFeatureChangeListener$ChangeNotificationProcessorThread)
    [2023-03-08 13:34:51,622] INFO [feature-zk-node-event-process-thread]: Stopped (kafka.server.FinalizedFeatureChangeListener$ChangeNotificationProcessorThread)
    [2023-03-08 13:34:51,623] INFO [ZooKeeperClient Kafka server] Closing. (kafka.zookeeper.ZooKeeperClient)
    [2023-03-08 13:34:51,730] INFO Session: 0x10077e8b5ab0000 closed (org.apache.zookeeper.ZooKeeper)
    [2023-03-08 13:34:51,730] INFO EventThread shut down for session: 0x10077e8b5ab0000 (org.apache.zookeeper.ClientCnxn)
    [2023-03-08 13:34:51,733] INFO [ZooKeeperClient Kafka server] Closed. (kafka.zookeeper.ZooKeeperClient)
    [2023-03-08 13:34:51,734] INFO [ThrottledChannelReaper-Fetch]: Shutting down (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,737] INFO [ThrottledChannelReaper-Fetch]: Stopped (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,738] INFO [ThrottledChannelReaper-Fetch]: Shutdown completed (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,738] INFO [ThrottledChannelReaper-Produce]: Shutting down (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,739] INFO [ThrottledChannelReaper-Produce]: Stopped (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,739] INFO [ThrottledChannelReaper-Produce]: Shutdown completed (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,739] INFO [ThrottledChannelReaper-Request]: Shutting down (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,740] INFO [ThrottledChannelReaper-Request]: Stopped (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,740] INFO [ThrottledChannelReaper-Request]: Shutdown completed (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,740] INFO [ThrottledChannelReaper-ControllerMutation]: Shutting down (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,741] INFO [ThrottledChannelReaper-ControllerMutation]: Stopped (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,741] INFO [ThrottledChannelReaper-ControllerMutation]: Shutdown completed (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:34:51,743] INFO [SocketServer listenerType=ZK_BROKER, nodeId=0] Shutting down socket server (kafka.network.SocketServer)
    [2023-03-08 13:34:51,782] INFO [SocketServer listenerType=ZK_BROKER, nodeId=0] Shutdown completed (kafka.network.SocketServer)
    [2023-03-08 13:34:51,783] INFO Metrics scheduler closed (org.apache.kafka.common.metrics.Metrics)
    [2023-03-08 13:34:51,783] INFO Closing reporter org.apache.kafka.common.metrics.JmxReporter (org.apache.kafka.common.metrics.Metrics)
    [2023-03-08 13:34:51,784] INFO Metrics reporters closed (org.apache.kafka.common.metrics.Metrics)
    [2023-03-08 13:34:51,785] INFO Broker and topic stats closed (kafka.server.BrokerTopicStats)
    [2023-03-08 13:34:51,785] INFO App info kafka.server for 0 unregistered (org.apache.kafka.common.utils.AppInfoParser)
    [2023-03-08 13:34:51,786] INFO [KafkaServer id=0] shut down completed (kafka.server.KafkaServer)

``` python
broker_1 = ApacheKafkaBroker()
async with broker_1:
    port = broker_1.zookeeper_kwargs["zookeeper_port"]
    broker_2 = ApacheKafkaBroker(zookeeper_port=port, retries=0)
    with pytest.raises(ValueError) as e:
        async with broker_2:
            pass

assert e.value.args[0].startswith("Could not start zookeeper with params:")

for broker in [broker_2]:
    assert broker.zookeeper_task == None
#     print("*" * 50 + "ZOOKEEPER LOGS" + "+" * 50)
#     zookeeper_output, _ = await broker.zookeeper_task.communicate()
#     print(zookeeper_output.decode("UTF-8"))
```

    [INFO] __main__: Java is already installed.
    [INFO] __main__: Kafka is already installed.
    [INFO] __main__: Starting zookeeper...
    stdout=b'', stderr=b'', returncode=1
    [INFO] __main__: zookeeper startup falied, generating a new port and retrying...
    [INFO] __main__: port=39569
    [INFO] __main__: Starting kafka...
    [INFO] __main__: Local Kafka broker up and running on 127.0.0.1:9092
    [INFO] __main__: Java is already installed.
    [INFO] __main__: Kafka is already installed.
    [INFO] __main__: Starting zookeeper...
    stdout=b'', stderr=b'', returncode=1
    [INFO] __main__: zookeeper startup falied, generating a new port and retrying...
    [INFO] __main__: port=38265
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 722097...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 722097 terminated.
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 721737...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 721737 terminated.

------------------------------------------------------------------------

<a
href="https://github.com/airtai/fastkafka/blob/main/fastkafka/_testing/apache_kafka_broker.py#L558"
target="_blank" style={{float: 'right', fontSize: 'smaller'}}>source</a>

### ApacheKafkaBroker.stop

>      ApacheKafkaBroker.stop ()

Stops a local kafka broker and zookeeper instance synchronously Returns:
None

------------------------------------------------------------------------

<a
href="https://github.com/airtai/fastkafka/blob/main/fastkafka/_testing/apache_kafka_broker.py#L515"
target="_blank" style={{float: 'right', fontSize: 'smaller'}}>source</a>

### ApacheKafkaBroker.start

>      ApacheKafkaBroker.start ()

Starts a local kafka broker and zookeeper instance synchronously
Returns: Kafka broker bootstrap server address in string format:
add:port

``` python
broker = ApacheKafkaBroker(apply_nest_asyncio=True)
with broker:
    print("Hello world!")

print("*" * 50 + "ZOOKEEPER LOGS" + "+" * 50)
zookeeper_output, _ = await broker.zookeeper_task.communicate()
print(zookeeper_output.decode("UTF-8"))


print("*" * 50 + "KAFKA LOGS" + "+" * 50)
kafka_output, _ = await broker.kafka_task.communicate()
print(kafka_output.decode("UTF-8"))
```

    [INFO] __main__: ApacheKafkaBroker.start(): entering...
    [WARNING] __main__: ApacheKafkaBroker.start(): (<_UnixSelectorEventLoop running=True closed=False debug=False>) is already running!
    [WARNING] __main__: ApacheKafkaBroker.start(): calling nest_asyncio.apply()
    [INFO] __main__: Java is already installed.
    [INFO] __main__: Kafka is already installed.
    [INFO] __main__: Starting zookeeper...
    stdout=b'', stderr=b'', returncode=1
    [INFO] __main__: zookeeper startup falied, generating a new port and retrying...
    [INFO] __main__: port=49167
    [INFO] __main__: Starting kafka...
    [INFO] __main__: Local Kafka broker up and running on 127.0.0.1:9092
    [INFO] __main__: <class 'fastkafka.testing.ApacheKafkaBroker'>.start(): returning 127.0.0.1:9092
    [INFO] __main__: ApacheKafkaBroker.start(): exited.
    Hello world!
    [INFO] __main__: ApacheKafkaBroker.stop(): entering...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 723599...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 723599 terminated.
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 723239...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 723239 terminated.
    [INFO] __main__: ApacheKafkaBroker.stop(): exited.
    **************************************************ZOOKEEPER LOGS++++++++++++++++++++++++++++++++++++++++++++++++++
    [2023-03-08 13:38:26,294] INFO zookeeper.request_throttler.shutdownTimeout = 10000 (org.apache.zookeeper.server.RequestThrottler)
    [2023-03-08 13:38:26,294] INFO PrepRequestProcessor (sid:0) started, reconfigEnabled=false (org.apache.zookeeper.server.PrepRequestProcessor)
    [2023-03-08 13:38:26,310] INFO Using checkIntervalMs=60000 maxPerMinute=10000 maxNeverUsedIntervalMs=0 (org.apache.zookeeper.server.ContainerManager)
    [2023-03-08 13:38:26,311] INFO ZooKeeper audit is disabled. (org.apache.zookeeper.audit.ZKAuditProvider)
    [2023-03-08 13:38:27,463] INFO Creating new log file: log.1 (org.apache.zookeeper.server.persistence.FileTxnLog)

    **************************************************KAFKA LOGS++++++++++++++++++++++++++++++++++++++++++++++++++
    [2023-03-08 13:38:28,756] INFO [BrokerToControllerChannelManager broker=0 name=forwarding]: Recorded new controller, from now on will use node tvrtko-fastkafka-devel:9092 (id: 0 rack: null) (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:38:28,783] INFO [BrokerToControllerChannelManager broker=0 name=alterPartition]: Recorded new controller, from now on will use node tvrtko-fastkafka-devel:9092 (id: 0 rack: null) (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:38:29,711] INFO Terminating process due to signal SIGTERM (org.apache.kafka.common.utils.LoggingSignalHandler)
    [2023-03-08 13:38:29,715] INFO [KafkaServer id=0] shutting down (kafka.server.KafkaServer)
    [2023-03-08 13:38:29,719] INFO [KafkaServer id=0] Starting controlled shutdown (kafka.server.KafkaServer)
    [2023-03-08 13:38:29,761] INFO [KafkaServer id=0] Controlled shutdown request returned successfully after 29ms (kafka.server.KafkaServer)
    [2023-03-08 13:38:29,767] INFO [/config/changes-event-process-thread]: Shutting down (kafka.common.ZkNodeChangeNotificationListener$ChangeEventProcessThread)
    [2023-03-08 13:38:29,769] INFO [/config/changes-event-process-thread]: Stopped (kafka.common.ZkNodeChangeNotificationListener$ChangeEventProcessThread)
    [2023-03-08 13:38:29,769] INFO [/config/changes-event-process-thread]: Shutdown completed (kafka.common.ZkNodeChangeNotificationListener$ChangeEventProcessThread)
    [2023-03-08 13:38:29,770] INFO [SocketServer listenerType=ZK_BROKER, nodeId=0] Stopping socket server request processors (kafka.network.SocketServer)
    [2023-03-08 13:38:29,779] INFO [SocketServer listenerType=ZK_BROKER, nodeId=0] Stopped socket server request processors (kafka.network.SocketServer)
    [2023-03-08 13:38:29,780] INFO [data-plane Kafka Request Handler on Broker 0], shutting down (kafka.server.KafkaRequestHandlerPool)
    [2023-03-08 13:38:29,782] INFO [data-plane Kafka Request Handler on Broker 0], shut down completely (kafka.server.KafkaRequestHandlerPool)
    [2023-03-08 13:38:29,785] INFO [ExpirationReaper-0-AlterAcls]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,786] INFO [ExpirationReaper-0-AlterAcls]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,786] INFO [ExpirationReaper-0-AlterAcls]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,787] INFO [KafkaApi-0] Shutdown complete. (kafka.server.KafkaApis)
    [2023-03-08 13:38:29,787] INFO [ExpirationReaper-0-topic]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,788] INFO [ExpirationReaper-0-topic]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,788] INFO [ExpirationReaper-0-topic]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,790] INFO [TransactionCoordinator id=0] Shutting down. (kafka.coordinator.transaction.TransactionCoordinator)
    [2023-03-08 13:38:29,790] INFO [Transaction State Manager 0]: Shutdown complete (kafka.coordinator.transaction.TransactionStateManager)
    [2023-03-08 13:38:29,791] INFO [Transaction Marker Channel Manager 0]: Shutting down (kafka.coordinator.transaction.TransactionMarkerChannelManager)
    [2023-03-08 13:38:29,792] INFO [Transaction Marker Channel Manager 0]: Stopped (kafka.coordinator.transaction.TransactionMarkerChannelManager)
    [2023-03-08 13:38:29,792] INFO [Transaction Marker Channel Manager 0]: Shutdown completed (kafka.coordinator.transaction.TransactionMarkerChannelManager)
    [2023-03-08 13:38:29,793] INFO [TransactionCoordinator id=0] Shutdown complete. (kafka.coordinator.transaction.TransactionCoordinator)
    [2023-03-08 13:38:29,793] INFO [GroupCoordinator 0]: Shutting down. (kafka.coordinator.group.GroupCoordinator)
    [2023-03-08 13:38:29,794] INFO [ExpirationReaper-0-Heartbeat]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,795] INFO [ExpirationReaper-0-Heartbeat]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,795] INFO [ExpirationReaper-0-Heartbeat]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,795] INFO [ExpirationReaper-0-Rebalance]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,796] INFO [ExpirationReaper-0-Rebalance]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,796] INFO [ExpirationReaper-0-Rebalance]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,796] INFO [GroupCoordinator 0]: Shutdown complete. (kafka.coordinator.group.GroupCoordinator)
    [2023-03-08 13:38:29,797] INFO [ReplicaManager broker=0] Shutting down (kafka.server.ReplicaManager)
    [2023-03-08 13:38:29,797] INFO [LogDirFailureHandler]: Shutting down (kafka.server.ReplicaManager$LogDirFailureHandler)
    [2023-03-08 13:38:29,798] INFO [LogDirFailureHandler]: Shutdown completed (kafka.server.ReplicaManager$LogDirFailureHandler)
    [2023-03-08 13:38:29,798] INFO [LogDirFailureHandler]: Stopped (kafka.server.ReplicaManager$LogDirFailureHandler)
    [2023-03-08 13:38:29,798] INFO [ReplicaFetcherManager on broker 0] shutting down (kafka.server.ReplicaFetcherManager)
    [2023-03-08 13:38:29,799] INFO [ReplicaFetcherManager on broker 0] shutdown completed (kafka.server.ReplicaFetcherManager)
    [2023-03-08 13:38:29,799] INFO [ReplicaAlterLogDirsManager on broker 0] shutting down (kafka.server.ReplicaAlterLogDirsManager)
    [2023-03-08 13:38:29,800] INFO [ReplicaAlterLogDirsManager on broker 0] shutdown completed (kafka.server.ReplicaAlterLogDirsManager)
    [2023-03-08 13:38:29,800] INFO [ExpirationReaper-0-Fetch]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,800] INFO [ExpirationReaper-0-Fetch]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,800] INFO [ExpirationReaper-0-Fetch]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,801] INFO [ExpirationReaper-0-Produce]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,801] INFO [ExpirationReaper-0-Produce]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,802] INFO [ExpirationReaper-0-Produce]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,802] INFO [ExpirationReaper-0-DeleteRecords]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,803] INFO [ExpirationReaper-0-DeleteRecords]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,803] INFO [ExpirationReaper-0-DeleteRecords]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,803] INFO [ExpirationReaper-0-ElectLeader]: Shutting down (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,804] INFO [ExpirationReaper-0-ElectLeader]: Stopped (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,804] INFO [ExpirationReaper-0-ElectLeader]: Shutdown completed (kafka.server.DelayedOperationPurgatory$ExpiredOperationReaper)
    [2023-03-08 13:38:29,809] INFO [ReplicaManager broker=0] Shut down completely (kafka.server.ReplicaManager)
    [2023-03-08 13:38:29,809] INFO [BrokerToControllerChannelManager broker=0 name=alterPartition]: Shutting down (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:38:29,810] INFO [BrokerToControllerChannelManager broker=0 name=alterPartition]: Stopped (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:38:29,810] INFO [BrokerToControllerChannelManager broker=0 name=alterPartition]: Shutdown completed (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:38:29,812] INFO Broker to controller channel manager for alterPartition shutdown (kafka.server.BrokerToControllerChannelManagerImpl)
    [2023-03-08 13:38:29,812] INFO [BrokerToControllerChannelManager broker=0 name=forwarding]: Shutting down (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:38:29,813] INFO [BrokerToControllerChannelManager broker=0 name=forwarding]: Stopped (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:38:29,813] INFO [BrokerToControllerChannelManager broker=0 name=forwarding]: Shutdown completed (kafka.server.BrokerToControllerRequestThread)
    [2023-03-08 13:38:29,813] INFO Broker to controller channel manager for forwarding shutdown (kafka.server.BrokerToControllerChannelManagerImpl)
    [2023-03-08 13:38:29,814] INFO Shutting down. (kafka.log.LogManager)
    [2023-03-08 13:38:29,837] INFO Shutdown complete. (kafka.log.LogManager)
    [2023-03-08 13:38:29,843] INFO [feature-zk-node-event-process-thread]: Shutting down (kafka.server.FinalizedFeatureChangeListener$ChangeNotificationProcessorThread)
    [2023-03-08 13:38:29,843] INFO [feature-zk-node-event-process-thread]: Shutdown completed (kafka.server.FinalizedFeatureChangeListener$ChangeNotificationProcessorThread)
    [2023-03-08 13:38:29,843] INFO [feature-zk-node-event-process-thread]: Stopped (kafka.server.FinalizedFeatureChangeListener$ChangeNotificationProcessorThread)
    [2023-03-08 13:38:29,843] INFO [ZooKeeperClient Kafka server] Closing. (kafka.zookeeper.ZooKeeperClient)
    [2023-03-08 13:38:29,951] INFO Session: 0x10077ec0a410000 closed (org.apache.zookeeper.ZooKeeper)
    [2023-03-08 13:38:29,951] INFO EventThread shut down for session: 0x10077ec0a410000 (org.apache.zookeeper.ClientCnxn)
    [2023-03-08 13:38:29,954] INFO [ZooKeeperClient Kafka server] Closed. (kafka.zookeeper.ZooKeeperClient)
    [2023-03-08 13:38:29,955] INFO [ThrottledChannelReaper-Fetch]: Shutting down (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,959] INFO [ThrottledChannelReaper-Fetch]: Stopped (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,959] INFO [ThrottledChannelReaper-Fetch]: Shutdown completed (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,960] INFO [ThrottledChannelReaper-Produce]: Shutting down (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,960] INFO [ThrottledChannelReaper-Produce]: Stopped (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,961] INFO [ThrottledChannelReaper-Produce]: Shutdown completed (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,961] INFO [ThrottledChannelReaper-Request]: Shutting down (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,962] INFO [ThrottledChannelReaper-Request]: Stopped (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,962] INFO [ThrottledChannelReaper-Request]: Shutdown completed (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,962] INFO [ThrottledChannelReaper-ControllerMutation]: Shutting down (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,963] INFO [ThrottledChannelReaper-ControllerMutation]: Stopped (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,963] INFO [ThrottledChannelReaper-ControllerMutation]: Shutdown completed (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
    [2023-03-08 13:38:29,966] INFO [SocketServer listenerType=ZK_BROKER, nodeId=0] Shutting down socket server (kafka.network.SocketServer)
    [2023-03-08 13:38:30,010] INFO [SocketServer listenerType=ZK_BROKER, nodeId=0] Shutdown completed (kafka.network.SocketServer)
    [2023-03-08 13:38:30,010] INFO Metrics scheduler closed (org.apache.kafka.common.metrics.Metrics)
    [2023-03-08 13:38:30,010] INFO Closing reporter org.apache.kafka.common.metrics.JmxReporter (org.apache.kafka.common.metrics.Metrics)
    [2023-03-08 13:38:30,010] INFO Metrics reporters closed (org.apache.kafka.common.metrics.Metrics)
    [2023-03-08 13:38:30,012] INFO Broker and topic stats closed (kafka.server.BrokerTopicStats)
    [2023-03-08 13:38:30,013] INFO App info kafka.server for 0 unregistered (org.apache.kafka.common.utils.AppInfoParser)
    [2023-03-08 13:38:30,013] INFO [KafkaServer id=0] shut down completed (kafka.server.KafkaServer)

``` python
topics = ["topic_1", "topic_2"]

async with ApacheKafkaBroker(topics=topics) as bootstrap_server:
    task = await asyncio.create_subprocess_exec(
        "kafka-topics.sh",
        "--list",
        f"--bootstrap-server={bootstrap_server}",
        stdout=asyncio.subprocess.PIPE,
        stdin=asyncio.subprocess.PIPE,
    )
    output, _ = await asyncio.wait_for(task.communicate(), 30)
    listed_topics = output.decode("UTF-8").split("\n")[:-1]
    assert set(listed_topics) == set(topics)
print("ok")
```

    [INFO] __main__: Java is already installed.
    [INFO] __main__: Kafka is already installed.
    [INFO] __main__: Starting zookeeper...
    stdout=b'', stderr=b'', returncode=1
    [INFO] __main__: zookeeper startup falied, generating a new port and retrying...
    [INFO] __main__: port=34731
    [INFO] __main__: Starting kafka...
    [INFO] __main__: Local Kafka broker up and running on 127.0.0.1:9092
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 724751...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 724751 terminated.
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 724390...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 724390 terminated.
    ok

``` python
test_topic = "test-topic"
test_msg = b"test-msg"

with ApacheKafkaBroker(
    topics=[test_topic], apply_nest_asyncio=True
) as bootstrap_server:
    consumer = AIOKafkaConsumer(test_topic, bootstrap_servers=bootstrap_server)

    producer = AIOKafkaProducer(bootstrap_servers=bootstrap_server)

    await consumer.start()
    await producer.start()

    try:
        await producer.send_and_wait(test_topic, test_msg)
        msg = await consumer.getone()
        assert msg, value == test_msg
    finally:
        await consumer.stop()
        await producer.stop()
```

    [INFO] __main__: ApacheKafkaBroker.start(): entering...
    [WARNING] __main__: ApacheKafkaBroker.start(): (<_UnixSelectorEventLoop running=True closed=False debug=False>) is already running!
    [WARNING] __main__: ApacheKafkaBroker.start(): calling nest_asyncio.apply()
    [INFO] __main__: Java is already installed.
    [INFO] __main__: Kafka is already installed.
    [INFO] __main__: Starting zookeeper...
    stdout=b'', stderr=b'', returncode=1
    [INFO] __main__: zookeeper startup falied, generating a new port and retrying...
    [INFO] __main__: port=51025
    [INFO] __main__: Starting kafka...
    [INFO] __main__: Local Kafka broker up and running on 127.0.0.1:9092
    [INFO] __main__: <class 'fastkafka.testing.ApacheKafkaBroker'>.start(): returning 127.0.0.1:9092
    [INFO] __main__: ApacheKafkaBroker.start(): exited.
    [INFO] aiokafka.consumer.subscription_state: Updating subscribed topics to: frozenset({'test-topic'})
    [INFO] aiokafka.consumer.group_coordinator: Metadata for topic has changed from {} to {'test-topic': 1}. 
    [INFO] __main__: ApacheKafkaBroker.stop(): entering...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 726924...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 726924 terminated.
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 726562...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 726562 terminated.
    [INFO] __main__: ApacheKafkaBroker.stop(): exited.

``` python
test_topic = "test-topic"
test_msg = b"test-msg"

async with ApacheKafkaBroker(topics=[test_topic]) as bootstrap_server:
    consumer = AIOKafkaConsumer(test_topic, bootstrap_servers=bootstrap_server)

    producer = AIOKafkaProducer(bootstrap_servers=bootstrap_server)

    await consumer.start()
    await producer.start()

    try:
        await producer.send_and_wait(test_topic, test_msg)
        msg = await consumer.getone()
        assert msg, value == test_msg
    finally:
        await consumer.stop()
        await producer.stop()
```

    [INFO] __main__: Java is already installed.
    [INFO] __main__: Kafka is already installed.
    [INFO] __main__: Starting zookeeper...
    stdout=b'', stderr=b'', returncode=1
    [INFO] __main__: zookeeper startup falied, generating a new port and retrying...
    [INFO] __main__: port=37997
    [INFO] __main__: Starting kafka...
    [INFO] __main__: Local Kafka broker up and running on 127.0.0.1:9092
    [INFO] aiokafka.consumer.subscription_state: Updating subscribed topics to: frozenset({'test-topic'})
    [INFO] aiokafka.consumer.group_coordinator: Metadata for topic has changed from {} to {'test-topic': 1}. 
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 728416...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 728416 terminated.
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Terminating the process 728056...
    [INFO] fastkafka._components._subprocess: terminate_asyncio_process(): Process 728056 terminated.
